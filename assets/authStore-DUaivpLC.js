import{bd as D,aL as j,O as w,r as A,aM as f}from"./index-Df0vDIYO.js";import{g as x,c as E,u as y}from"./useApi-CrpjD065.js";const k=A(null),d=A(null);function M(r){return r?r.abilities&&Array.isArray(r.abilities)?r.abilities:[{action:"manage",subject:"all"}]:[]}function O(){const r=D(),b=j(),h=w(()=>!!x()&&(!d.value||Date.now()<d.value)),p=w(()=>{var n;return(((n=k.value)==null?void 0:n.status)??0)===1}),_=w(()=>d.value?Math.max(0,d.value-Date.now()):null);async function S({email:n,phone:o,password:c}){var l,g;const m={identifier:n||o,password:c,token_name:"web"},{data:a,error:t}=await y("/v1/dashboard/login").post(m).json();if(t!=null&&t.value){const v=((g=(l=t.value)==null?void 0:l.data)==null?void 0:g.message)||"الايميل أو كلمة المرور غير صحيحة";throw new Error(v)}const e=(a==null?void 0:a.value)||{},u=e.token,s=e.data||null;k.value=s;const i=M(s);return r.setUser(s),r.setClient(s.client),r.setOffice(s.office),f("userData").value=s,f("accessToken").value=u,f("userAbilityRules").value=i,b.update(i),r.isLoginUser(),{user:s,message:e.message,isVerified:p.value}}async function I({email:n,identifier:o,channel:c="email"}){var s,i;const m=o||n||phone,a={channel:c,identifier:m},{data:t,error:e}=await y("/v1/forgot-password").post(a).text();if(e!=null&&e.value){const l=((i=(s=e.value)==null?void 0:s.data)==null?void 0:i.message)||"فشل إرسال رمز التحقق";throw new Error(l)}return{message:((t==null?void 0:t.value)||{}).message}}async function T({channel:n="email",identifier:o,code:c}){var s,i,l,g;const m={channel:n,identifier:o,code:c},{data:a,error:t}=await y("/v1/verify-reset-code").post(m).json();if(t!=null&&t.value){const v=((i=(s=t.value)==null?void 0:s.data)==null?void 0:i.message)||"رمز التحقق غير صحيح";throw new Error(v)}const e=(a==null?void 0:a.value)||{},u=(e==null?void 0:e.token)||((l=e==null?void 0:e.data)==null?void 0:l.token)||((g=e==null?void 0:e.data)==null?void 0:g.reset_token)||null;try{o&&sessionStorage.setItem("reset_identifier",o),u&&sessionStorage.setItem("reset_token",u),n&&sessionStorage.setItem("reset_channel",n)}catch{}return{message:e.message,data:e.data,token:u}}async function C({password:n,password_confirmation:o,identifier:c,token:m}){var l,g;const a=(()=>{try{return sessionStorage.getItem("reset_identifier")}catch{return null}})(),t=(()=>{try{return sessionStorage.getItem("reset_token")}catch{return null}})(),e={identifier:c||a,token:m||t,password:n,password_confirmation:o},{data:u,error:s}=await y("/v1/reset-password").post(e).json();if(s!=null&&s.value){const v=((g=(l=s.value)==null?void 0:l.data)==null?void 0:g.message)||"فشل إعادة تعيين كلمة المرور";throw new Error(v)}const i=(u==null?void 0:u.value)||{};try{sessionStorage.removeItem("reset_identifier"),sessionStorage.removeItem("reset_token"),sessionStorage.removeItem("reset_channel")}catch{}return{message:i.message,data:i.data}}function R(){const n=f("accessToken"),o=f("userData"),c=f("userAbilityRules");n.value=null,o.value=null,c.value=null,b.update([]),r.clearUser(),k.value=null,d.value=null,E()}return{user:k,isAuthenticated:h,isVerified:p,remainingMs:_,login:S,forgotPassword:I,verifyResetCode:T,resetPassword:C,logout:R}}export{O as u};
